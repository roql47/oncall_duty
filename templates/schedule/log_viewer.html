{% extends "base.html" %}

{% block title %}ë¡œê·¸ ë·°ì–´{% endblock %}

{% block extra_css %}
<style>
    .log-viewer {
        font-family: 'Courier New', monospace;
        background-color: #1e1e1e;
        color: #d4d4d4;
        padding: 20px;
        border-radius: 8px;
        overflow-x: auto;
        max-height: 600px;
        overflow-y: auto;
        border: 1px solid #444;
    }
    
    .log-line {
        margin: 2px 0;
        padding: 4px 8px;
        border-radius: 4px;
        white-space: pre-wrap;
        font-size: 13px;
    }
    
    .log-line:hover {
        background-color: #2d2d30;
    }
    
    .log-level-INFO { border-left: 3px solid #4CAF50; }
    .log-level-WARNING { border-left: 3px solid #FF9800; }
    .log-level-ERROR { border-left: 3px solid #F44336; }
    .log-level-DEBUG { border-left: 3px solid #2196F3; }
    .log-level-CRITICAL { border-left: 3px solid #E91E63; }
    
    .log-controls {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .form-row {
        display: flex;
        gap: 15px;
        align-items: end;
        flex-wrap: wrap;
    }
    
    .form-group {
        flex: 1;
        min-width: 150px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #333;
    }
    
    .form-control {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }
    
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
    }
    
    .btn-primary {
        background-color: #007bff;
        color: white;
    }
    
    .btn-primary:hover {
        background-color: #0056b3;
    }
    
    .btn-secondary {
        background-color: #6c757d;
        color: white;
    }
    
    .btn-secondary:hover {
        background-color: #545b62;
    }
    
    .stats-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }
    
    .stat-item {
        text-align: center;
    }
    
    .stat-value {
        font-size: 2em;
        font-weight: bold;
        color: #007bff;
    }
    
    .stat-label {
        color: #666;
        font-size: 0.9em;
    }
    
    .loading {
        text-align: center;
        padding: 40px;
        color: #666;
    }
    
    .error-message {
        background-color: #f8d7da;
        color: #721c24;
        padding: 10px 15px;
        border-radius: 4px;
        margin-bottom: 20px;
        border: 1px solid #f5c6cb;
    }
    
    .log-meta {
        font-size: 11px;
        color: #888;
        margin-left: 10px;
    }
    
    .auto-refresh {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .auto-refresh input[type="checkbox"] {
        transform: scale(1.2);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <h2>ğŸ“‹ ë¡œê·¸ ë·°ì–´</h2>
            <p class="text-muted">ì‹œìŠ¤í…œ ë¡œê·¸ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ì¡°íšŒí•˜ê³  ë¶„ì„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>
    </div>
    
    <!-- ë¡œê·¸ ì¡°íšŒ ì»¨íŠ¸ë¡¤ -->
    <div class="log-controls">
        <form id="logViewerForm">
            <div class="form-row">
                <div class="form-group">
                    <label for="backend">ë°±ì—”ë“œ</label>
                    <select id="backend" name="backend" class="form-control">
                        <option value="django">Django</option>
                        <option value="fastapi">FastAPI</option>
                        <option value="system">System</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="logType">ë¡œê·¸ íƒ€ì…</label>
                    <select id="logType" name="logType" class="form-control">
                        <option value="access">Access</option>
                        <option value="api">API</option>
                        <option value="chatbot">Chatbot</option>
                        <option value="error">Error</option>
                        <option value="debug">Debug</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="date">ë‚ ì§œ</label>
                    <input type="date" id="date" name="date" class="form-control" value="">
                </div>
                
                <div class="form-group">
                    <label for="lines">ë¼ì¸ ìˆ˜</label>
                    <select id="lines" name="lines" class="form-control">
                        <option value="50">50</option>
                        <option value="100">100</option>
                        <option value="200">200</option>
                        <option value="500">500</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button type="submit" class="btn btn-primary">ë¡œê·¸ ì¡°íšŒ</button>
                </div>
                
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button type="button" id="refreshBtn" class="btn btn-secondary">ìƒˆë¡œê³ ì¹¨</button>
                </div>
                
                <div class="form-group auto-refresh">
                    <label>
                        <input type="checkbox" id="autoRefresh"> ìë™ ìƒˆë¡œê³ ì¹¨ (30ì´ˆ)
                    </label>
                </div>
            </div>
        </form>
    </div>
    
    <!-- í†µê³„ ì¹´ë“œ -->
    <div class="stats-card" id="statsCard" style="display: none;">
        <h5>ğŸ“Š ë¡œê·¸ í†µê³„</h5>
        <div class="stats-grid" id="statsGrid">
            <!-- í†µê³„ ë°ì´í„°ê°€ ì—¬ê¸°ì— ë¡œë“œë©ë‹ˆë‹¤ -->
        </div>
    </div>
    
    <!-- ë¡œê·¸ ë‚´ìš© -->
    <div class="log-viewer" id="logContent">
        <div class="loading">
            ğŸ” ë¡œê·¸ë¥¼ ì¡°íšŒí•˜ë ¤ë©´ ìœ„ì˜ ì¡°ê±´ì„ ì„¤ì •í•˜ê³  "ë¡œê·¸ ì¡°íšŒ" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.
        </div>
    </div>
</div>

<script>
// ì˜¤ëŠ˜ ë‚ ì§œë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
document.getElementById('date').value = new Date().toISOString().split('T')[0];

// ë°±ì—”ë“œ ë³€ê²½ ì‹œ ë¡œê·¸ íƒ€ì… ì˜µì…˜ ì—…ë°ì´íŠ¸
document.getElementById('backend').addEventListener('change', function() {
    const backend = this.value;
    const logTypeSelect = document.getElementById('logType');
    
    // ê¸°ì¡´ ì˜µì…˜ ì œê±°
    logTypeSelect.innerHTML = '';
    
    let options = [];
    if (backend === 'system') {
        options = [
            {value: 'startup', text: 'Startup'},
            {value: 'performance', text: 'Performance'},
            {value: 'security', text: 'Security'}
        ];
    } else {
        options = [
            {value: 'access', text: 'Access'},
            {value: 'api', text: 'API'},
            {value: 'chatbot', text: 'Chatbot'},
            {value: 'error', text: 'Error'},
            {value: 'debug', text: 'Debug'}
        ];
    }
    
    options.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt.value;
        option.textContent = opt.text;
        logTypeSelect.appendChild(option);
    });
});

// í¼ ì œì¶œ ì²˜ë¦¬
document.getElementById('logViewerForm').addEventListener('submit', function(e) {
    e.preventDefault();
    loadLogs();
});

// ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼
document.getElementById('refreshBtn').addEventListener('click', function() {
    loadLogs();
});

// ìë™ ìƒˆë¡œê³ ì¹¨ ì„¤ì •
let autoRefreshInterval = null;
document.getElementById('autoRefresh').addEventListener('change', function() {
    if (this.checked) {
        autoRefreshInterval = setInterval(loadLogs, 30000); // 30ì´ˆë§ˆë‹¤
    } else {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
        }
    }
});

// ë¡œê·¸ ë¡œë“œ í•¨ìˆ˜
async function loadLogs() {
    const formData = new FormData(document.getElementById('logViewerForm'));
    const params = new URLSearchParams();
    
    for (let [key, value] of formData.entries()) {
        params.append(key, value);
    }
    
    const logContent = document.getElementById('logContent');
    logContent.innerHTML = '<div class="loading">â³ ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
    
    try {
        const response = await fetch(`/schedule/api/logs/?${params.toString()}`);
        const data = await response.json();
        
        if (data.success) {
            displayLogs(data.logs);
            displayStats(data.stats);
        } else {
            logContent.innerHTML = `<div class="error-message">âŒ ${data.error || 'ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'}</div>`;
        }
    } catch (error) {
        console.error('ë¡œê·¸ ë¡œë“œ ì˜¤ë¥˜:', error);
        logContent.innerHTML = '<div class="error-message">âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
    }
}

// ë¡œê·¸ í‘œì‹œ í•¨ìˆ˜
function displayLogs(logs) {
    const logContent = document.getElementById('logContent');
    
    if (!logs || logs.length === 0) {
        logContent.innerHTML = '<div class="loading">ğŸ“„ í•´ë‹¹ ì¡°ê±´ì˜ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
    }
    
    const logHtml = logs.map((log, index) => {
        let logClass = '';
        let logText = '';
        let logMeta = '';
        
        try {
            // JSON ë¡œê·¸ íŒŒì‹± ì‹œë„
            const logData = JSON.parse(log);
            logClass = `log-level-${logData.level || 'INFO'}`;
            logText = `[${logData.timestamp}] [${logData.level}] ${logData.message}`;
            
            // ì¶”ê°€ ë©”íƒ€ì •ë³´ êµ¬ì„±
            const metaItems = [];
            if (logData.request_id) metaItems.push(`ID: ${logData.request_id.substring(0, 8)}`);
            if (logData.session_id) metaItems.push(`Session: ${logData.session_id.substring(0, 8)}`);
            if (logData.ip_address) metaItems.push(`IP: ${logData.ip_address}`);
            if (logData.response_time) metaItems.push(`${logData.response_time}ms`);
            if (logData.status_code) metaItems.push(`HTTP ${logData.status_code}`);
            if (logData.message_length) metaItems.push(`MsgLen: ${logData.message_length}`);
            if (logData.response_length) metaItems.push(`ResLen: ${logData.response_length}`);
            
            if (metaItems.length > 0) {
                logMeta = `<span class="log-meta">${metaItems.join(' | ')}</span>`;
            }
            
        } catch (e) {
            // JSONì´ ì•„ë‹Œ ì¼ë°˜ ë¡œê·¸
            logClass = 'log-level-INFO';
            logText = log;
        }
        
        return `<div class="log-line ${logClass}">${escapeHtml(logText)}${logMeta}</div>`;
    }).join('');
    
    logContent.innerHTML = logHtml;
    
    // ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ
    logContent.scrollTop = logContent.scrollHeight;
}

// í†µê³„ í‘œì‹œ í•¨ìˆ˜
function displayStats(stats) {
    const statsCard = document.getElementById('statsCard');
    const statsGrid = document.getElementById('statsGrid');
    
    if (!stats) {
        statsCard.style.display = 'none';
        return;
    }
    
    const statsHtml = `
        <div class="stat-item">
            <div class="stat-value">${stats.total_lines || 0}</div>
            <div class="stat-label">ì´ ë¡œê·¸ ë¼ì¸</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">${(stats.file_size / (1024 * 1024)).toFixed(2)}MB</div>
            <div class="stat-label">íŒŒì¼ í¬ê¸°</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">${stats.error_count || 0}</div>
            <div class="stat-label">ì—ëŸ¬ ìˆ˜</div>
        </div>
        <div class="stat-item">
            <div class="stat-value">${stats.warning_count || 0}</div>
            <div class="stat-label">ê²½ê³  ìˆ˜</div>
        </div>
    `;
    
    statsGrid.innerHTML = statsHtml;
    statsCard.style.display = 'block';
}

// HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, function(m) { return map[m]; });
}

// ì´ˆê¸° ë¡œë“œ
window.addEventListener('load', function() {
    // ê¸°ë³¸ì ìœ¼ë¡œ Django API ë¡œê·¸ë¥¼ ì˜¤ëŠ˜ ë‚ ì§œë¡œ ë¡œë“œ
    loadLogs();
});
</script>
{% endblock %} 