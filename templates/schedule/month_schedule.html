{% extends 'base.html' %}
{% load static %}

{% block title %}{{ year }}년 {{ month }}월 당직 일정 - 당직 스케줄 시스템{% endblock %}

{% block extra_css %}
<style>
    body {
        overflow-x: hidden;
    }
    
    .card {
        overflow: hidden;
    }
    
    .schedule-container {
        width: 100%;
        border: 1px solid #dee2e6;
        margin-bottom: 20px;
        -webkit-overflow-scrolling: touch;
    }
    
    .schedule-table {
        table-layout: fixed;
        border-collapse: collapse;
        width: auto;
        min-width: 2000px; /* 기존 2500px에서 축소 */
        font-size: 13px; /* 전체 폰트 크기 증가 (11px -> 13px) */
    }
    
    .schedule-table th, .schedule-table td {
        border: 1px solid #dee2e6;
        padding: 8px 6px; /* 패딩 조금 증가 (6px 5px -> 8px 6px) */
        text-align: center;
        white-space: nowrap;
        font-size: 13px; /* 셀 폰트 크기 증가 (11px -> 13px) */
    }
    
    .department-col {
        min-width: 120px; /* 기존 150px에서 축소 */
        position: sticky;
        left: 0;
        background-color: #f8f9fa;
        z-index: 1;
        box-shadow: 2px 0 5px -2px rgba(0,0,0,0.1);
        font-size: 12px; /* 부서명 폰트 크기 증가 (10px -> 12px) */
        padding: 6px 4px; /* 부서 컬럼 패딩 증가 (4px 3px -> 6px 4px) */
    }
    
    .date-col {
        min-width: 100px; /* 기존 180px에서 대폭 축소 */
        font-size: 12px; /* 날짜 폰트 크기 증가 (10px -> 12px) */
        padding: 6px 4px; /* 날짜 컬럼 패딩 증가 (4px 3px -> 6px 4px) */
    }
    
    /* 스크롤바 스타일 커스터마이징 - 슬림하게 개선 */
    .schedule-container::-webkit-scrollbar {
        height: 10px; /* 스크롤바 높이 축소 (14px -> 10px) */
        width: 10px; /* 세로 스크롤바 너비도 축소 */
    }
    
    .schedule-container::-webkit-scrollbar-track {
        background: #f1f3f4; /* 매우 연한 회색 배경 */
        border-radius: 5px;
        border: none; /* 테두리 제거로 더 깔끔하게 */
    }
    
    .schedule-container::-webkit-scrollbar-thumb {
        background: #c1c7cd; /* 부드러운 회색 */
        border-radius: 5px;
        border: none; /* 테두리 제거 */
        min-width: 30px; /* 최소 너비 축소 (50px -> 30px) */
        transition: all 0.2s ease; /* 부드러운 전환 효과 */
    }
    
    .schedule-container::-webkit-scrollbar-thumb:hover {
        background: #8d9499; /* 호버 시 조금 더 진한 회색 */
        transform: scale(1.05); /* 살짝 확대 효과 */
    }
    
    .schedule-container::-webkit-scrollbar-thumb:active {
        background: #6c757d; /* 클릭 시 더 진한 회색 */
        transform: scale(0.95); /* 클릭 시 살짝 축소 */
    }
    
    /* 스크롤바를 화면 하단에 고정시키는 스타일 */
    .schedule-wrapper {
        position: relative;
        height: calc(100vh - 340px); /* 헤더와 네비게이션 높이를 제외한 나머지 높이 (슬림한 스크롤바에 맞춰 조정) */
        min-height: 400px; /* 최소 높이 보장 */
    }
    
    .schedule-container {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        overflow: auto; /* 가로, 세로 스크롤 모두 허용 */
    }
    
    /* 가로 스크롤바가 항상 보이도록 하는 대안 방법 */
    .horizontal-scroll-track {
        position: sticky;
        bottom: 0;
        left: 0;
        right: 0;
        height: 12px; /* 높이 축소 (17px -> 12px) */
        background: #f8f9fa;
        border-top: 1px solid #e9ecef; /* 더 연한 테두리 */
        overflow-x: auto;
        overflow-y: hidden;
        z-index: 10;
    }
    
    .horizontal-scroll-content {
        height: 1px;
        width: 2000px; /* 테이블과 동일한 최소 너비 */
        background: transparent;
    }
    
    /* 하단 고정 스크롤바 스타일 */
    .horizontal-scroll-track::-webkit-scrollbar {
        height: 8px; /* 더 슬림하게 (12px에서 8px로) */
    }
    
    .horizontal-scroll-track::-webkit-scrollbar-track {
        background: #f1f3f4; /* 매우 연한 회색 배경 */
        border-radius: 4px;
    }
    
    .horizontal-scroll-track::-webkit-scrollbar-thumb {
        background: #c1c7cd; /* 부드러운 회색 */
        border-radius: 4px;
        border: none; /* 테두리 제거 */
        min-width: 30px;
        transition: all 0.2s ease; /* 부드러운 전환 효과 */
    }
    
    .horizontal-scroll-track::-webkit-scrollbar-thumb:hover {
        background: #8d9499; /* 호버 시 조금 더 진한 회색 */
        transform: scale(1.05); /* 살짝 확대 효과 */
    }

    
    .weekend {
        background-color: #f8f9fa;
    }
    
    .schedule-item {
        background-color: #e3f2fd;
        padding: 5px 25px 5px 6px; /* 우측에 아이콘 공간 확보, 좌측 패딩 증가 */
        margin-bottom: 3px; /* 마진 증가 (2px -> 3px) */
        border-radius: 3px; /* 둥근 모서리 증가 (2px -> 3px) */
        position: relative;
        font-size: 11px; /* 스케줄 아이템 폰트 크기 증가 (9px -> 11px) */
        line-height: 1.2; /* 줄 간격 조정 */
        min-height: 40px; /* 최소 높이 설정으로 아이콘 공간 확보 */
    }
    
    .admin-controls {
        display: flex;
        justify-content: center;
        margin-top: 2px;
    }
    
    .success-flash {
        background-color: #d4edda !important;
        transition: background-color 1s;
    }
    
    .error-flash {
        background-color: #f8d7da !important;
        transition: background-color 1s;
    }
    
    .delete-schedule {
        position: absolute;
        top: 1px;
        right: 1px;
        color: #dc3545;
        cursor: pointer;
        font-size: 0.75rem;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 2px;
        padding: 1px 3px;
        line-height: 1;
    }
    
    .delete-schedule:hover {
        color: #c82333;
        background: rgba(255, 255, 255, 0.95);
    }
    
    .change-doctor {
        position: absolute;
        top: 1px;
        right: 18px;
        color: #0d6efd;
        cursor: pointer;
        font-size: 0.7rem;
        background: rgba(255, 255, 255, 0.8);
        border-radius: 2px;
        padding: 1px 2px;
        line-height: 1;
    }
    
    .change-doctor:hover {
        color: #0b5ed7;
        background: rgba(255, 255, 255, 0.95);
    }
    
    .add-schedule-btn {
        width: 24px;
        height: 24px;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        border-radius: 4px;
        font-size: 10px;
        border-width: 1px;
        transition: all 0.15s ease;
        color: #6c757d;
        border-color: #dee2e6;
        background-color: transparent;
    }
    
    .add-schedule-btn:hover {
        transform: scale(1.05);
        color: #495057;
        border-color: #adb5bd;
        background-color: #f8f9fa;
    }
    
    .mini-modal {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background-color: white;
        padding: 12px;
        border-radius: 5px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.3);
        z-index: 1000;
        width: 320px;
        max-width: 95vw;
        margin-bottom: 8px;
        border: 1px solid #dee2e6;
    }
    
    .mini-modal:after {
        content: '';
        position: absolute;
        bottom: -8px;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-top: 8px solid white;
    }
    
    /* 맨 위칸용 모달 (아래쪽에서 나타남) */
    .mini-modal.show-below {
        bottom: auto;
        top: 100%;
        margin-bottom: 0;
        margin-top: 8px;
    }
    
    .mini-modal.show-below:after {
        bottom: auto;
        top: -8px;
        border-top: none;
        border-bottom: 8px solid white;
    }
    
    .mini-modal .form-label {
        font-size: 0.8rem;
        margin-bottom: 0;
        color: #666;
        width: 70px;
        white-space: nowrap;
    }
    
    .mini-modal .form-select {
        font-size: 0.85rem;
        padding: 4px 8px;
        height: auto;
    }
    
    .mini-modal .btn {
        font-size: 0.8rem;
        padding: 3px 8px;
    }
    
    .floating-mini-modal {
        position: relative;
    }
    
    .form-row {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
    }
    
    .form-select-container {
        flex: 1;
    }
    
    .btn-row {
        display: flex;
        justify-content: flex-end;
        margin-top: 8px;
    }
    
    /* 필터링 옵션 스타일 */
    .filter-options {
        padding: 8px 0;
        border-top: 1px solid #eee;
        margin-top: 10px;
    }
    
    .form-check-inline {
        margin-right: 15px;
    }
    
    .form-check-input {
        cursor: pointer;
    }
    
    .form-check-label {
        font-size: 0.9rem;
        cursor: pointer;
    }
    
    /* 스케줄 아이템 구조 */
    .schedule-item {
        display: flex;
        flex-direction: column;
        position: relative;
        gap: 2px;
        justify-content: flex-start;
    }
    
    .time-info {
        display: flex;
        align-items: center;
        font-weight: bold;
        height: 16px;
        font-size: 11px;
        margin-bottom: 2px;
    }
    
    .doctor-info {
        display: flex;
        flex-direction: column;
        margin-right: 25px; /* 아이콘 공간 확보 */
        gap: 1px;
    }
    
    .doctor-name {
        display: flex;
        align-items: center;
        font-size: 11px; /* 의사 이름 폰트 크기 명시적 설정 */
        height: 14px;
        line-height: 1;
    }
    
    .schedule-item .contact-info,
    .schedule-item .phone-number {
        display: flex;
        align-items: center;
        font-size: 10px; /* 연락처 폰트 크기 증가 (0.8em -> 10px) */
        color: #6c757d; /* text-muted와 동일한 색상 */
        height: 12px;
        line-height: 1;
    }
    
    /* 숨김 상태를 위한 클래스 추가 */
    .contact-info.hide-contact,
    .phone-number.hide-contact {
        display: none !important;
    }
    
    /* 스케줄 셀 스타일 추가 */
    .schedule-cell {
        min-width: 180px;
        white-space: normal;
        padding: 6px;
        vertical-align: top;
    }
    
    /* 첫 주 일괄 적용 아이콘 스타일 */
    .apply-first-week-icon {
        color: #28a745;
        cursor: pointer;
        margin-left: 8px;
        font-size: 1.1rem;
        transition: color 0.2s;
    }
    
    .apply-first-week-icon:hover {
        color: #1e7e34;
    }
    
    .department-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        white-space: nowrap;
        padding: 1px; /* 패딩 축소 */
    }
    
    .department-name {
        flex: 1;
        text-overflow: ellipsis;
        overflow: hidden;
        font-size: 12px; /* 부서명 폰트 크기 증가 (9px -> 12px) */
        font-weight: 600; /* 굵기 약간 축소 */
    }

/* 인쇄용 스타일 */
@media print {
    .print-button-container {
        display: none !important;
    }
    
    .btn, .navbar, .sidebar, .footer {
        display: none !important;
    }
    
    .schedule-wrapper {
        height: auto !important;
        position: static !important;
    }
    
    .schedule-container {
        overflow: visible !important;
        max-height: none !important;
        position: static !important;
    }
    
    .horizontal-scroll-track {
        display: none !important;
    }
    
    .schedule-table {
        page-break-inside: avoid;
        font-size: 10px !important; /* 인쇄 시 폰트 크기 증가 (8px -> 10px) */
        min-width: auto !important;
    }
    
    .schedule-table th,
    .schedule-table td {
        border: 1px solid #000 !important;
        padding: 3px 4px !important; /* 인쇄 시 패딩 증가 (2px 3px -> 3px 4px) */
        font-size: 10px !important; /* 인쇄 시 폰트 크기 증가 (8px -> 10px) */
    }
    
    .schedule-table th {
        background-color: #f8f9fa !important;
        print-color-adjust: exact;
        -webkit-print-color-adjust: exact;
    }
    
    .department-col {
        min-width: 60px !important; /* 인쇄 시 부서명 컬럼 더 축소 */
        font-size: 9px !important; /* 인쇄용 부서명 폰트 크기 증가 (7px -> 9px) */
    }
    
    .date-col {
        min-width: 40px !important; /* 인쇄 시 날짜 컬럼 더 축소 */
        font-size: 9px !important; /* 인쇄용 날짜 폰트 크기 증가 (7px -> 9px) */
    }
    
    .schedule-item {
        font-size: 8px !important; /* 인쇄용 스케줄 아이템 폰트 크기 증가 (6px -> 8px) */
        padding: 2px !important; /* 인쇄용 패딩 증가 (1px -> 2px) */
        margin-bottom: 1px !important;
    }
    
    .department-name {
        font-size: 8px !important; /* 인쇄용 부서명 폰트 크기 증가 (6px -> 8px) */
    }
    
    .card, .card-body {
        box-shadow: none !important;
        border: none !important;
    }
    
    .container-fluid {
        padding: 0 !important;
    }
    
    /* 페이지 여백 설정 */
    @page {
        margin: 1cm;
        size: A4 landscape;
    }
    
    body {
        font-size: 12px !important;
    }
    
    .schedule-item {
        word-break: break-word;
        line-height: 1.2;
    }
    
    .department-label {
        font-weight: bold;
        font-size: 10px !important;
    }
    
    .doctor-name {
        font-size: 9px !important; /* 인쇄용 의사명 폰트 크기 조정 (11px -> 9px) */
    }
    
    .contact-info {
        font-size: 8px !important; /* 인쇄용 연락처 폰트 크기 조정 (9px -> 8px) */
        color: #666 !important;
    }
}
</style>
{% endblock %}



{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-2"> <!-- mb-4에서 mb-2로 축소 -->
            <h2 class="mb-0" style="font-size: 1.5rem;">{{ year }}년 {{ month }}월 당직 일정</h2> <!-- h1에서 h2로, 크기 축소 -->
            <div class="btn-group">
                <a href="{% url 'schedule:week_schedule' year=year month=month week=1 %}" class="btn btn-outline-primary btn-sm"> <!-- btn-sm 추가 -->
                    <i class="bi bi-calendar-week"></i> 주간 일정
                </a>
                {% if user.is_staff %}
                <button id="copyPrevMonthBtn" class="btn btn-outline-secondary btn-sm"> <!-- btn-sm 추가 -->
                    <i class="bi bi-calendar-plus"></i> 이전 달 일정 복사
                </button>
                <button id="deleteMonthScheduleBtn" class="btn btn-outline-danger btn-sm"> <!-- btn-sm 추가 -->
                    <i class="bi bi-trash3"></i> 이번 달 일정 삭제
                </button>
                {% endif %}
            </div>
        </div>

        <div class="mb-2 d-flex justify-content-between align-items-center flex-wrap"> <!-- mb-3에서 mb-2로, 플렉스 레이아웃 적용 -->
            {% now "Y" as current_year %}
            {% now "m" as current_month %}
            
            <div class="nav-buttons"> <!-- 네비게이션 버튼 그룹 -->
                {% with prev_month=month|add:"-1" prev_year=year %}
                    {% if prev_month == 0 %}
                        {% with prev_month=12 prev_year=year|add:"-1" %}
                            <a href="{% url 'schedule:month_schedule' year=prev_year month=prev_month %}" class="btn btn-outline-primary btn-sm me-1"> <!-- btn-sm 추가, 마진 축소 -->
                                <i class="bi bi-chevron-left"></i> 이전 달
                            </a>
                        {% endwith %}
                    {% else %}
                        <a href="{% url 'schedule:month_schedule' year=prev_year month=prev_month %}" class="btn btn-outline-primary btn-sm me-1"> <!-- btn-sm 추가, 마진 축소 -->
                            <i class="bi bi-chevron-left"></i> 이전 달
                        </a>
                    {% endif %}
                {% endwith %}
                
                {% with next_month=month|add:"1" next_year=year %}
                    {% if next_month == 13 %}
                        {% with next_month=1 next_year=year|add:"1" %}
                            <a href="{% url 'schedule:month_schedule' year=next_year month=next_month %}" class="btn btn-outline-primary btn-sm">
                                다음 달 <i class="bi bi-chevron-right"></i>
                            </a>
                        {% endwith %}
                    {% else %}
                        <a href="{% url 'schedule:month_schedule' year=next_year month=next_month %}" class="btn btn-outline-primary btn-sm">
                            다음 달 <i class="bi bi-chevron-right"></i>
                        </a>
                    {% endif %}
                {% endwith %}
            </div>
            
            <div class="btn-group"> <!-- 주간 버튼들 -->
                <a href="{% url 'schedule:week_schedule' year=year month=month week=1 %}" class="btn btn-outline-secondary btn-sm">1주</a> <!-- btn-sm 추가 -->
                <a href="{% url 'schedule:week_schedule' year=year month=month week=2 %}" class="btn btn-outline-secondary btn-sm">2주</a>
                <a href="{% url 'schedule:week_schedule' year=year month=month week=3 %}" class="btn btn-outline-secondary btn-sm">3주</a>
                <a href="{% url 'schedule:week_schedule' year=year month=month week=4 %}" class="btn btn-outline-secondary btn-sm">4주</a>
                {% if month == 1 or month == 3 or month == 5 or month == 7 or month == 8 or month == 10 or month == 12 %}
                <a href="{% url 'schedule:week_schedule' year=year month=month week=5 %}" class="btn btn-outline-secondary btn-sm">5주</a>
                {% endif %}
            </div>
        </div>



        <div class="card">
            <div class="card-header py-2"> <!-- 패딩 축소 -->
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">일정 표</h6> <!-- h5에서 h6로 축소 -->
                    <div class="filter-options">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="show-work-time" checked>
                            <label class="form-check-label small" for="show-work-time">근무시간</label> <!-- small 클래스 추가 -->
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="checkbox" id="show-doctor-name" checked>
                        <label class="form-check-label" for="show-doctor-name">의사 이름</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="show-phone-number" checked>
                        <label class="form-check-label" for="show-phone-number">연락처</label>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <!-- 프린트 버튼 -->
<div class="print-button-container" style="margin-bottom: 10px; text-align: right;"> <!-- 마진 축소 -->
    <button onclick="window.print()" class="btn btn-outline-primary btn-sm" id="print-btn"> <!-- btn-sm 추가 -->
        <i class="bi bi-printer"></i> 프린트
    </button>
</div>


<div class="schedule-wrapper">
                    <div class="schedule-container">
                        <table class="schedule-table">
                            <thead>
                                <tr>
                                    <th class="bg-light department-col">부서/날짜</th>
                                    {% for date, schedules in schedules_by_date.items %}
                                    <th class="{% if date.weekday == 5 or date.weekday == 6 %}weekend{% endif %} date-col">
                                        {{ date|date:"d" }}({{ date|date:"D"|upper }})
                                    </th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for department in departments %}
                                <tr>
                                    <th class="bg-light department-col">
                                        <div class="department-header">
                                            <span class="department-name">{{ department.name }}</span>
                                            {% if user.is_staff %}
                                            <i class="bi bi-arrow-repeat apply-first-week-icon" 
                                               title="1일~7일 스케줄을 이 달 전체에 적용"
                                               data-department-id="{{ department.id }}"
                                               data-department-name="{{ department.name }}"></i>
                                            {% endif %}
                                        </div>
                                    </th>
                                    {% for date, schedules in schedules_by_date.items %}
                                    <td class="{% if date.weekday == 5 or date.weekday == 6 %}weekend{% endif %} schedule-cell" 
                                        data-date="{{ date|date:'Y-m-d' }}" 
                                        data-department="{{ department.id }}">
                                        
                                        {% regroup schedules|dictsort:"work_schedule.start_time" by work_schedule as work_schedule_list %}
                                        {% for work_schedule_group in work_schedule_list %}
                                            {% for schedule in work_schedule_group.list %}
                                                {% if schedule.doctor.department.id == department.id %}
                                                    <div class="schedule-item" 
                                                         id="schedule-{{ schedule.id }}"
                                                         data-schedule-id="{{ schedule.id }}"
                                                         data-work-schedule="{{ schedule.work_schedule.id }}"
                                                         data-doctor="{{ schedule.doctor.id }}">
                                                        {% if user.is_staff %}
                                                        <span class="delete-schedule" title="삭제">×</span>
                                                        <span class="change-doctor" title="당직의 변경">
                                                            <i class="bi bi-pencil-square"></i>
                                                        </span>
                                                        {% endif %}
                                                        <div class="time-info">
                                                            <strong>{{ work_schedule_group.grouper }}</strong>
                                                        </div>
                                                        <div class="doctor-info">
                                                            <span class="doctor-name">{{ schedule.doctor.name }}</span>
                                                            <span class="contact-info phone-number">{{ schedule.doctor.phone_number }}</span>
                                                        </div>
                                                    </div>
                                                {% endif %}
                                            {% endfor %}
                                        {% endfor %}
                                        
                                        {% if user.is_staff %}
                                        <div class="admin-controls">
                                            <button class="btn btn-sm btn-outline-secondary add-schedule-btn" title="스케줄 추가">
                                                <i class="bi bi-plus"></i>
                                            </button>
                                        </div>
                                        {% endif %}
                                    </td>
                                    {% endfor %}
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="{{ schedules_by_date.keys|length|add:1 }}">등록된 부서가 없습니다.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- 하단 고정 스크롤바 -->
                <div class="horizontal-scroll-track">
                    <div class="horizontal-scroll-content"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 미니 모달 템플릿 (동적으로 추가됨) -->
<div id="miniModalTemplate" style="display: none;">
    <div class="mini-modal">
        <div class="form-row">
            <label class="form-label">근무시간:</label>
            <div class="form-select-container">
                <select class="form-select form-select-sm work-schedule-select">
                    <option value="">-- 선택 --</option>
                </select>
            </div>
        </div>
        <div class="form-row">
            <label class="form-label">의사:</label>
            <div class="form-select-container">
                <select class="form-select form-select-sm doctor-select">
                    <option value="">-- 선택 --</option>
                </select>
            </div>
        </div>
        <div class="btn-row">
            <button class="btn btn-sm btn-secondary me-2 cancel-mini-modal">취소</button>
            <button class="btn btn-sm btn-primary save-schedule">저장</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- 모든 사용자를 위한 체크박스 필터링 기능 -->
<script>
$(document).ready(function() {
    // 필터링 체크박스 이벤트 처리
    $('#show-work-time').change(function() {
        if($(this).is(':checked')) {
            $('.time-info').show();
        } else {
            $('.time-info').hide();
        }
    });
    
    $('#show-doctor-name').change(function() {
        if($(this).is(':checked')) {
            $('.doctor-name').show();
        } else {
            $('.doctor-name').hide();
        }
    });
    
    $('#show-phone-number').change(function() {
        if($(this).is(':checked')) {
            $('.contact-info, .phone-number').removeClass('hide-contact');
        } else {
            $('.contact-info, .phone-number').addClass('hide-contact');
        }
    });
    
    // 초기 체크박스 상태에 따라 필터링 적용
    $('#show-work-time').trigger('change');
    $('#show-doctor-name').trigger('change');
    $('#show-phone-number').trigger('change');
    
    // 스크롤바 동기화 
    const scheduleContainer = $('.schedule-container');
    const horizontalScrollTrack = $('.horizontal-scroll-track');
    
    // 메인 컨테이너의 스크롤 이벤트 처리
    scheduleContainer.on('scroll', function() {
        const scrollLeft = this.scrollLeft;
        horizontalScrollTrack.scrollLeft(scrollLeft);
    });
    
    // 하단 스크롤바의 스크롤 이벤트 처리  
    horizontalScrollTrack.on('scroll', function() {
        const scrollLeft = this.scrollLeft;
        scheduleContainer.scrollLeft(scrollLeft);
    });
});
</script>

{% if user.is_staff %}
<script>
$(document).ready(function() {
    console.log("스케줄 페이지 로드됨");
    
    // 전역 변수로 워크스케줄 데이터 저장
    let allWorkSchedules = [];
    
    // 초기에 근무시간 데이터 로드
    $.ajax({
        url: '{% url "schedule:get_work_schedules" %}',
        type: 'GET',
        success: function(data) {
            allWorkSchedules = data.work_schedules;
        },
        error: function() {
            console.error('근무시간 데이터를 불러오는데 실패했습니다.');
        }
    });

    // 이전 달 일정 복사 버튼 클릭 이벤트
    $('#copyPrevMonthBtn').on('click', function() {
        if (confirm('이전 달의 근무시간을 현재 달로 복사하시겠습니까?')) {
            const currentYear = parseInt('{{ year }}');
            const currentMonth = parseInt('{{ month }}');
            let prevYear = currentYear;
            let prevMonth = currentMonth - 1;
            
            if (prevMonth === 0) {
                prevYear = currentYear - 1;
                prevMonth = 12;
            }
            
            $.ajax({
                url: '{% url "schedule:copy_prev_month_schedule" %}',
                type: 'POST',
                data: {
                    'current_year': currentYear,
                    'current_month': currentMonth,
                    'prev_year': prevYear,
                    'prev_month': prevMonth,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response.status === 'success') {
                        alert('이전 달의 근무시간이 성공적으로 복사되었습니다.');
                        location.reload();
                    } else {
                        alert(response.message || '복사 중 오류가 발생했습니다.');
                    }
                },
                error: function(xhr) {
                    const response = xhr.responseJSON;
                    alert(response.message || '복사 중 오류가 발생했습니다.');
                }
            });
        }
    });

    
    // 스케줄 추가 버튼 클릭 시
    $(document).on('click', '.add-schedule-btn', function() {
        console.log("더하기 버튼 클릭됨");
        
        // 모든 열린 미니 모달 닫기
        $('.floating-mini-modal').remove();
        
        const cell = $(this).closest('.schedule-cell');
        const dateStr = cell.data('date');
        const departmentId = cell.data('department');
        
        // 미니 모달 템플릿 복제하고 준비
        const modalContent = $('#miniModalTemplate').html();
        const floatingModal = $('<div class="floating-mini-modal"></div>').html(modalContent);
        
        // 모달을 버튼 위에 추가
        $(this).closest('.admin-controls').prepend(floatingModal);
        
        // 맨 위 행인지 확인하고 모달 위치 조정
        const row = cell.closest('tr');
        const rowIndex = row.index();
        if (rowIndex <= 1) { // 헤더 다음의 첫 번째 행 (0: 헤더, 1: 첫 번째 데이터 행)
            floatingModal.find('.mini-modal').addClass('show-below');
        }
        
        // 모달 데이터 설정
        const $modal = floatingModal;
        $modal.find('.mini-modal').data('date', dateStr);
        $modal.find('.mini-modal').data('department', departmentId);
        
        // 근무시간 옵션 로딩
        const $workScheduleSelect = $modal.find('.work-schedule-select');
        $workScheduleSelect.empty().append('<option value="">-- 선택 --</option>');
        
        // 부서별 근무시간 로딩
        $.ajax({
            url: '{% url "schedule:get_work_schedules_by_department" %}',
            type: 'GET',
            data: {
                'department_id': departmentId
            },
            success: function(data) {
                data.work_schedules.forEach(function(ws) {
                    $workScheduleSelect.append(`<option value="${ws.id}" data-display="${ws.display}">${ws.display}</option>`);
                });
            },
            error: function() {
                console.error('부서별 근무시간 데이터를 불러오는데 실패했습니다.');
                allWorkSchedules.forEach(function(ws) {
                    $workScheduleSelect.append(`<option value="${ws.id}" data-display="${ws.display}">${ws.display}</option>`);
                });
            }
        });
        
        // 의사 목록 로딩
        $.ajax({
            url: '{% url "schedule:get_doctors_by_department" %}',
            type: 'GET',
            data: {
                'department_id': departmentId
            },
            success: function(data) {
                const $doctorSelect = $modal.find('.doctor-select');
                $doctorSelect.empty().append('<option value="">-- 선택 --</option>');
                
                data.doctors.forEach(function(doctor) {
                    $doctorSelect.append(`<option value="${doctor.id}">${doctor.name}</option>`);
                });
            },
            error: function() {
                alert('의사 목록을 불러오는 중 오류가 발생했습니다.');
                floatingModal.remove();
            }
        });
        
        // 배경 클릭 시 닫기 이벤트 위임
        $(document).on('click', function(e) {
            if (!$(e.target).closest('.floating-mini-modal').length && 
                !$(e.target).hasClass('add-schedule-btn') && 
                !$(e.target).closest('.add-schedule-btn').length) {
                $('.floating-mini-modal').remove();
                $(document).off('click.closeModal');
            }
        });
        
        // 이벤트 핸들러에 네임스페이스 지정
        $(document).on('click.closeModal');
        
        // 취소 버튼 클릭 시
        $modal.find('.cancel-mini-modal').on('click', function(e) {
            e.stopPropagation();
            floatingModal.remove();
            $(document).off('click.closeModal');
        });
        
        // 저장 버튼 클릭 시
        $modal.find('.save-schedule').on('click', function(e) {
            e.stopPropagation();
            const workScheduleId = $modal.find('.work-schedule-select').val();
            const doctorId = $modal.find('.doctor-select').val();
            
            if (!workScheduleId || !doctorId) {
                alert('근무시간과 의사를 모두 선택해주세요.');
                return;
            }
            
            updateSchedule(cell, dateStr, workScheduleId, doctorId);
            floatingModal.remove();
            $(document).off('click.closeModal');
        });
        
        // 이벤트 버블링 방지
        floatingModal.on('click', function(e) {
            e.stopPropagation();
        });
    });
    
    // 삭제 아이콘 클릭 시
    $(document).on('click', '.delete-schedule', function(e) {
        e.stopPropagation();
        if (confirm('이 스케줄을 삭제하시겠습니까?')) {
            const scheduleItem = $(this).closest('.schedule-item');
            const scheduleId = scheduleItem.data('schedule-id');
            
            deleteSchedule(scheduleId, scheduleItem);
        }
    });
    
    // 당직의 변경 버튼 클릭 시
    $(document).on('click', '.change-doctor', function(e) {
        e.stopPropagation();
        
        const scheduleItem = $(this).closest('.schedule-item');
        const scheduleId = scheduleItem.data('schedule-id');
        const workScheduleId = scheduleItem.data('work-schedule');
        const departmentId = scheduleItem.closest('.schedule-cell').data('department');
        const dateStr = scheduleItem.closest('.schedule-cell').data('date');
        
        // 모든 열린 미니 모달 닫기
        $('.floating-mini-modal').remove();
        
        // 미니 모달 템플릿 복제하고 준비
        const modalContent = $('#miniModalTemplate').html();
        const floatingModal = $('<div class="floating-mini-modal"></div>').html(modalContent);
        
        // 모달을 스케줄 아이템 위에 추가
        scheduleItem.prepend(floatingModal);
        
        // 맨 위 행인지 확인하고 모달 위치 조정
        const cell = scheduleItem.closest('.schedule-cell');
        const row = cell.closest('tr');
        const rowIndex = row.index();
        if (rowIndex <= 1) { // 헤더 다음의 첫 번째 행 (0: 헤더, 1: 첫 번째 데이터 행)
            floatingModal.find('.mini-modal').addClass('show-below');
        }
        
        // 모달 데이터 설정
        const $modal = floatingModal;
        $modal.find('.mini-modal').data('date', dateStr);
        $modal.find('.mini-modal').data('department', departmentId);
        
        // 근무시간 선택 비활성화 및 현재 값 설정
        const $workScheduleSelect = $modal.find('.work-schedule-select');
        $workScheduleSelect.prop('disabled', true);
        $workScheduleSelect.val(workScheduleId);
        
        // 의사 목록 로딩
        $.ajax({
            url: '{% url "schedule:get_doctors_by_department" %}',
            type: 'GET',
            data: {
                'department_id': departmentId
            },
            success: function(data) {
                const $doctorSelect = $modal.find('.doctor-select');
                $doctorSelect.empty().append('<option value="">-- 선택 --</option>');
                
                data.doctors.forEach(function(doctor) {
                    $doctorSelect.append(`<option value="${doctor.id}">${doctor.name}</option>`);
                });
            },
            error: function() {
                alert('의사 목록을 불러오는 중 오류가 발생했습니다.');
                floatingModal.remove();
            }
        });
        
        // 배경 클릭 시 닫기 이벤트 위임
        $(document).on('click', function(e) {
            if (!$(e.target).closest('.floating-mini-modal').length && 
                !$(e.target).hasClass('change-doctor') && 
                !$(e.target).closest('.change-doctor').length) {
                $('.floating-mini-modal').remove();
                $(document).off('click.closeModal');
            }
        });
        
        // 이벤트 핸들러에 네임스페이스 지정
        $(document).on('click.closeModal');
        
        // 취소 버튼 클릭 시
        $modal.find('.cancel-mini-modal').on('click', function(e) {
            e.stopPropagation();
            floatingModal.remove();
            $(document).off('click.closeModal');
        });
        
        // 저장 버튼 클릭 시
        $modal.find('.save-schedule').on('click', function(e) {
            e.stopPropagation();
            const doctorId = $modal.find('.doctor-select').val();
            
            if (!doctorId) {
                alert('의사를 선택해주세요.');
                return;
            }
            
            updateSchedule(scheduleItem.closest('.schedule-cell'), dateStr, workScheduleId, doctorId);
            floatingModal.remove();
            $(document).off('click.closeModal');
        });
        
        // 이벤트 버블링 방지
        floatingModal.on('click', function(e) {
            e.stopPropagation();
        });
    });
    
    // 스케줄 업데이트 함수
    function updateSchedule(cell, dateStr, workScheduleId, doctorId) {
        $.ajax({
            url: '{% url "schedule:update_month_schedule" %}',
            type: 'POST',
            data: {
                'date': dateStr,
                'work_schedule_id': workScheduleId,
                'doctor_id': doctorId,
                'is_on_call': false,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.status === 'success') {
                    let scheduleItem = cell.find(`[data-work-schedule="${workScheduleId}"]`);
                    let workScheduleText = '';
                    
                    for (let i = 0; i < allWorkSchedules.length; i++) {
                        if (allWorkSchedules[i].id == workScheduleId) {
                            workScheduleText = allWorkSchedules[i].display;
                            break;
                        }
                    }
                    
                    if (scheduleItem.length === 0) {
                        scheduleItem = $('<div>')
                            .addClass('schedule-item')
                            .attr('data-schedule-id', response.schedule_id)
                            .attr('data-work-schedule', workScheduleId)
                            .attr('data-doctor', doctorId)
                            .html(`<span class="delete-schedule" title="삭제">×</span>
                                  <span class="change-doctor" title="당직의 변경">
                                      <i class="bi bi-pencil-square"></i>
                                  </span>
                                  <div class="time-info">
                                    <strong>${workScheduleText}</strong>
                                  </div>
                                  <div class="doctor-info">
                                    <span class="doctor-name">${response.doctor.name}</span>
                                    <span class="contact-info phone-number">${response.doctor.phone_number}</span>
                                  </div>`);
                        
                        cell.find('.admin-controls').before(scheduleItem);
                        
                        if(!$('#show-work-time').is(':checked')) {
                            scheduleItem.find('.time-info').hide();
                        }
                        if(!$('#show-doctor-name').is(':checked')) {
                            scheduleItem.find('.doctor-name').hide();
                        }
                        if(!$('#show-phone-number').is(':checked')) {
                            scheduleItem.find('.contact-info, .phone-number').addClass('hide-contact');
                        }
                    } else {
                        scheduleItem.attr('data-doctor', doctorId);
                        scheduleItem.find('strong').text(workScheduleText);
                        scheduleItem.find('.doctor-name').text(response.doctor.name);
                        scheduleItem.find('.contact-info, .phone-number').text(response.doctor.phone_number);
                    }
                    
                    cell.addClass('success-flash');
                    setTimeout(() => {
                        cell.removeClass('success-flash');
                    }, 1000);
                }
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                alert(response.message || '오류가 발생했습니다.');
                
                cell.addClass('error-flash');
                setTimeout(() => {
                    cell.removeClass('error-flash');
                }, 1000);
            }
        });
    }
    
    // 스케줄 삭제 함수
    function deleteSchedule(scheduleId, scheduleItem) {
        $.ajax({
            url: '{% url "schedule:delete_schedule" %}',
            type: 'POST',
            data: {
                'schedule_id': scheduleId,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.status === 'success') {
                    scheduleItem.fadeOut(300, function() {
                        $(this).remove();
                    });
                }
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                alert(response.message || '삭제 중 오류가 발생했습니다.');
            }
        });
    }
    
    // 이번 달 스케줄 삭제 버튼 클릭 이벤트
    $('#deleteMonthScheduleBtn').on('click', function(e) {
        e.preventDefault();
        
        const currentYear = parseInt('{{ year }}');
        const currentMonth = parseInt('{{ month }}');
        
        if (confirm(`⚠️ 경고: ${currentYear}년 ${currentMonth}월의 모든 스케줄이 삭제됩니다.\n\n정말로 삭제하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다.`)) {
            const $btn = $(this);
            const originalText = $btn.html();
            
            // 로딩 표시
            $btn.html('<span class="spinner-border spinner-border-sm me-2"></span>삭제 중...');
            $btn.prop('disabled', true);
            
            $.ajax({
                url: '{% url "schedule:delete_month_schedule" year=year month=month %}',
                type: 'POST',
                data: {
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response.success) {
                        alert(`✅ 성공: ${response.message}`);
                        // 페이지 새로고침
                        location.reload();
                    } else {
                        alert('❌ 오류: ' + response.message);
                    }
                },
                error: function(xhr) {
                    let errorMessage = '서버 오류가 발생했습니다.';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    }
                    alert('❌ 오류: ' + errorMessage);
                },
                complete: function() {
                    // 로딩 표시 해제
                    $btn.html(originalText);
                    $btn.prop('disabled', false);
                }
            });
        }
    });

    // 첫 주 스케줄 일괄 적용 아이콘 클릭 이벤트
    $(document).on('click', '.apply-first-week-icon', function(e) {
        e.stopPropagation();
        
        const departmentId = $(this).data('department-id');
        const departmentName = $(this).data('department-name');
        const currentYear = parseInt('{{ year }}');
        const currentMonth = parseInt('{{ month }}');
        
        if (confirm(`${departmentName}의 1일~7일 스케줄을 ${currentMonth}월 전체에 적용하시겠습니까?\n\n기존 스케줄은 모두 삭제되고 1일~7일 패턴으로 대체됩니다.`)) {
            const $icon = $(this);
            
            // 로딩 표시
            $icon.removeClass('bi-arrow-repeat').addClass('bi-hourglass-split');
            $icon.css('color', '#ffc107');
            
            $.ajax({
                url: '{% url "schedule:apply_first_week_schedule" %}',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    'department_id': departmentId,
                    'year': currentYear,
                    'month': currentMonth
                }),
                success: function(response) {
                    if (response.success) {
                        alert(response.message);
                        // 페이지 새로고침
                        location.reload();
                    } else {
                        alert('오류: ' + response.error);
                    }
                },
                error: function(xhr) {
                    alert('서버 오류가 발생했습니다.');
                },
                complete: function() {
                    // 로딩 표시 해제
                    $icon.removeClass('bi-hourglass-split').addClass('bi-arrow-repeat');
                    $icon.css('color', '');
                }
            });
        }
    });
});
</script>
{% endif %}
{% endblock %}